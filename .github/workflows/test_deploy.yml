name: Testing Deploy User Project Terraform

on:
  push:
    branches: 
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout repo (FULL history is REQUIRED)
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2Ô∏è‚É£ Detect newly added user
      - name: Detect user
        id: user
        run: |
          USER_ID="edarete"
          if [ -z "$USER_ID" ]; then
            echo "‚ùå No new user found"
            exit 1
          fi
 
          echo "‚úÖ Detected user: $USER_ID"
          echo "user_id=$USER_ID" >> $GITHUB_OUTPUT



      # 3Ô∏è‚É£ Azure Login
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      ###########################################################################

      # 4Ô∏è‚É£ Login to ACR
      - name: ACR Login
        run: |
          az acr login --name ${{ secrets.ACR_NAME }}

      ###########################################################################

      # 5Ô∏è‚É£ Build & Push Frontend Image
      - name: Build & Push Frontend
        run: |
          docker build \
            -t ${{ secrets.ACR_LOGIN_SERVER }}/frontend:${{ steps.user.outputs.user_id }} \
            --build-arg VITE_SECRET_KEY="${{ secrets.VITE_SECRET_KEY }}" \
            --build-arg VITE_PLATFORM_KEY="${{ secrets.VITE_PLATFORM_KEY }}" \
            --build-arg VITE_PLATFORM_VERSION="${{ secrets.VITE_PLATFORM_VERSION }}" \
            --build-arg VITE_PLATFORM_NAME="${{ secrets.VITE_PLATFORM_NAME }}" \
            --build-arg VITE_BASE_URL="http://backend-${{ steps.user.outputs.user_id }}:8080" \
            --build-arg VITE_SOCKET_URL="http://backend-${{ steps.user.outputs.user_id }}:8080/api" \
            projects/${{ steps.user.outputs.user_id }}/frontend

          docker push ${{ secrets.ACR_LOGIN_SERVER }}/frontend:${{ steps.user.outputs.user_id }}

      ###########################################################################

      # 6Ô∏è‚É£ Build & Push Backend Image
      - name: Build & Push Backend
        run: |
          docker build \
            -t ${{ secrets.ACR_LOGIN_SERVER }}/backend:${{ steps.user.outputs.user_id }} \
            projects/${{ steps.user.outputs.user_id }}/backend

          docker push ${{ secrets.ACR_LOGIN_SERVER }}/backend:${{ steps.user.outputs.user_id }}


      ###########################################################################
          
      # 7Ô∏è‚É£ Create MySQL Database for User
      - name: Create Database and User (If Needed)
        env:
          DB_HOST: "${{ secrets.MYSQL_SERVER_NAME }}.mysql.database.azure.com"
          ADMIN_USER: ${{ secrets.MYSQL_ADMIN_USER }}
          ADMIN_PASS: ${{ secrets.MYSQL_ADMIN_PASSWORD }}
          NEW_USER_PASS: ${{ secrets.TEMPORARY_USER_PASSWORD }}
          RESOURCE_GROUP: ${{ secrets.RESOURCE_GROUP }}
          MYSQL_SERVER_NAME: ${{ secrets.MYSQL_SERVER_NAME }}
        run: |
          TENANT_ID="${{ steps.user.outputs.user_id }}"
          #DB_NAME="${TENANT_ID}_db"
          DB_NAME="edarete_staging"
          USER_NAME="${TENANT_ID}_user"
          
          echo "üîç Checking if database exists: $DB_NAME"

          DB_EXISTS=$(az mysql flexible-server db list \
            --resource-group $RESOURCE_GROUP \
            --server-name $MYSQL_SERVER_NAME \
            --query "[?name=='$DB_NAME'].name" -o tsv)

          if [ -z "$DB_EXISTS" ]; then
            echo "üöÄ Creating database: $DB_NAME"
            az mysql flexible-server db create \
              --resource-group $RESOURCE_GROUP \
              --server-name $MYSQL_SERVER_NAME \
              --database-name $DB_NAME \
              --charset utf8mb4 \
              --collation utf8mb4_unicode_ci
          else
            echo "‚úÖ Database $DB_NAME already exists. Skipping creation."
          fi

          echo "üë§ Creating / Updating DB user and privileges"

          # mysql -h $DB_HOST -u $ADMIN_USER -p$ADMIN_PASS <<EOF
          # CREATE DATABASE IF NOT EXISTS \`$DB_NAME\`;
          # CREATE USER IF NOT EXISTS '$USER_NAME'@'%' IDENTIFIED BY '$NEW_USER_PASS';
          # GRANT ALL PRIVILEGES ON \`$DB_NAME\`.* TO '$USER_NAME'@'%';
          # FLUSH PRIVILEGES;
          # EOF

          #temp DB creating
          mysql -h $DB_HOST -u $ADMIN_USER -p$ADMIN_PASS <<EOF
          CREATE DATABASE IF NOT EXISTS \`edarete_staging\`;
          CREATE DATABASE IF NOT EXISTS \`securitydb\`;
          EOF

          echo "‚úÖ Database and user setup completed for tenant: $TENANT_ID"

      ###########################################################################    

      # 8Ô∏è‚É£ Import db.sql into User Database
      - name: Import User Database Schema
        run: |
          TENANT_ID="${{ steps.user.outputs.user_id }}"
          DB_NAME="${TENANT_ID}_db"
          USER_NAME="${TENANT_ID}_user"
          # DB_FILE="projects/${{ steps.user.outputs.user_id }}/database/backup.sql"

          # if [ ! -f "$DB_FILE" ]; then
          #   echo "‚ùå .sql file not found for user"
          #   exit 1
          # fi

          # mysql \
          #   -h ${{ secrets.MYSQL_SERVER_NAME }}.mysql.database.azure.com \
          #   -u $USER_NAME \
          #   -p${{ secrets.TEMPORARY_USER_PASSWORD }} \
          #   -D $DB_NAME \
          #   --ssl-mode=REQUIRED \
          #   < "$DB_FILE"

          #temp DB creating

          DB_FILE1="projects/${{ steps.user.outputs.user_id }}/database/securitydb.sql"
          DB_FILE2="projects/${{ steps.user.outputs.user_id }}/database/staging.sql"

          if [ ! -f "$DB_FILE1" ]; then
            echo "‚ùå .sql file not found for user"
            exit 1
          fi

          mysql \
            -h ${{ secrets.MYSQL_SERVER_NAME }}.mysql.database.azure.com \
            -u ${{ secrets.MYSQL_ADMIN_USER }} \
            -p$${{ secrets.MYSQL_ADMIN_PASSWORD }} \
            -D $edarete_staging \
            --ssl-mode=REQUIRED \
            < "$DB_FILE1"
            
          mysql \
            -h ${{ secrets.MYSQL_SERVER_NAME }}.mysql.database.azure.com \
            -u ${{ secrets.MYSQL_ADMIN_USER }} \
            -p$${{ secrets.MYSQL_ADMIN_PASSWORD }} \
            -D securitydb \
            --ssl-mode=REQUIRED \
            < "$DB_FILE2"
        
          

      ###########################################################################

      # 98Ô∏è‚É£ Trigger Terraform repository
      - name: Trigger Terraform Repo
        if: steps.user.outputs.user_id != ''
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.TOKEN }}
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: 'zeeshanali3',
              repo: 'framework-infra',
              workflow_id: 'deploy-user-terraform.yml',
              ref: 'main',
              inputs: {
                user_id: '${{ steps.user.outputs.user_id }}'
              }
            })
