name: "Generate Performance PDF"
on:
  schedule:
    - cron: '0 0 * * 1' # Weekly
  workflow_dispatch:

jobs:
  report:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Run Analysis Script
        id: metadata
        run: |
          # Captures the date range (e.g., 2025-12-29-to-2026-01-05)
          FNAME=$(python scripts/generate_report.py)
          echo "REPORT_NAME=$FNAME" >> $GITHUB_OUTPUT

      - name: Convert Markdown to PDF
        uses: baileyjm02/markdown-to-pdf@v1
        with:
          input_path: report.md
          output_dir: output_pdf
          build_pdf: true

      - name: Fix Permissions and Rename
        run: |
          # Use sudo to change ownership of the generated files back to the runner user
          sudo chown -R $USER:$USER output_pdf
          
          # Rename the default 'report.pdf' to your dynamic date-range name
          mv output_pdf/report.pdf ${{ steps.metadata.outputs.REPORT_NAME }}.pdf

      - name: Upload Report
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.metadata.outputs.REPORT_NAME }}
          path: ${{ steps.metadata.outputs.REPORT_NAME }}.pdf
